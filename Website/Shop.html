<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holz3D - Shop</title>

    <style>
        /* Deine bestehenden Styles bleiben alle gleich */
        a { font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif; text-decoration: none; color: black; transition: color 0.3s ease; }
        .menu { text-align: center; font-size: larger; }
        .menu nav a { padding: 0 15px; display: inline-block; }
        .menu nav a:hover { text-decoration: underline; color: grey; }
        .menu nav a.active { color: gray; text-decoration: none; pointer-events: none; }
        .overhead { font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif; text-align: center; font-size: 20px; cursor: pointer; }
        
        .auth-nav { position: absolute; top: 20px; right: 20px; display: flex; align-items: center; gap: 30px; z-index: 1000; }
        .auth-btn { padding: 8px 15px; border: 1px solid black; background: white; cursor: pointer; font-family: 'Franklin Gothic Medium', Arial, sans-serif; font-size: 14px; transition: 0.3s; }
        .auth-btn:hover { background: black; color: white; }
        #userStatus { font-family: 'Franklin Gothic Medium', Arial, sans-serif; font-size: 14px; }

        .product-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .product-card { background: white; border: 1px solid #ddd; padding: 15px; text-align: center; border-radius: 8px; transition: transform 0.2s; display: flex; flex-direction: column; }
        .product-card:hover { transform: scale(1.03); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); }
        .product-card img { width: 100%; height: auto; border-radius: 4px; }
        .price { font-weight: bold; color: #333; font-size: 18px; margin: 10px 0; }
        
        /* NEU: Styles für das Mengen-Feld */
        .qty-input {
            width: 50px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
            text-align: center;
        }
        .add-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: auto;
        }
        .add-btn { background: black; color: white; border: none; padding: 10px; flex-grow: 1; cursor: pointer; border-radius: 4px; font-weight: bold; }

        @media (max-width: 900px) { .product-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 500px) { .product-grid { grid-template-columns: 1fr; } }
    </style>
</head>

<body>

    <div class="auth-nav">
        <a href="cart.html" id="cartNav" style="font-family: Arial; font-size: 14px; border: 1px solid #ddd; padding: 8px 12px; border-radius: 4px;">
            Warenkorb <b id="cartCountDisplay">(0)</b>
        </a>
        <span id="userStatus"></span>
        <button id="auth-btn" class="auth-btn">Login</button>
    </div>

    <div class="overhead" onclick="window.location.href='main.html'">
        <h1> Holz3D Werk&reg;</h1>
    </div>

    <div class="menu">
        <nav>
            <a href="about_us.html"> About-us </a>
            <a href="3dprint.html"> 3D-Printing </a>
            <a href="wood.html"> Wood-laser </a>
        </nav>
    </div>

    <div class="shop-container">
        <div class="product-grid" id="productGrid">
            </div>
    </div>

    <script>
        const authURL = "https://script.google.com/macros/s/AKfycbx8qMQVx5771W_x6pxxiD4lmEplGck9yzHkIL9JEFE7wCjXXTuo2Jzge6u8T9HL9tgxtw/exec";
        let cart = JSON.parse(localStorage.getItem("cart")) || [];

        function displayProducts(products) {
            const grid = document.getElementById("productGrid");
            if (!products || products.length === 0) return;

            grid.innerHTML = ""; 
            products.forEach((product, index) => {
                const card = document.createElement("div");
                card.className = "product-card";
                card.innerHTML = `
                    <img src="${product.image || 'https://via.placeholder.com/150'}" alt="${product.name}">
                    <h3>${product.name}</h3>
                    <p style="font-size: 0.9em; color: #666;">${product.description || ""}</p>
                    <p class="price">${Number(product.price).toFixed(2)} €</p>
                    
                    <div class="add-container">
                        <input type="number" class="qty-input" id="qty-${index}" value="1" min="1" max="99">
                        <button class="add-btn" onclick="addToCart('${product.name}', ${product.price}, 'qty-${index}')">
                            Hinzufügen
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function loadProducts() {
            const cached = localStorage.getItem("product_cache");
            if (cached) { displayProducts(JSON.parse(cached)); }

            fetch(`${authURL}?action=getProducts`)
                .then(response => response.json())
                .then(products => {
                    localStorage.setItem("product_cache", JSON.stringify(products));
                    displayProducts(products);
                })
                .catch(err => console.error("Fehler beim Laden:", err));
        }

        // --- ANGEPASSTE ADD TO CART FUNKTION ---
        function addToCart(name, price, qtyId) {
            const quantity = parseInt(document.getElementById(qtyId).value) || 1;
            
            // Prüfen, ob Artikel bereits im Warenkorb
            const existingItem = cart.find(item => item.name === name);
            
            if (existingItem) {
                existingItem.quantity = (existingItem.quantity || 1) + quantity;
            } else {
                cart.push({ 
                    name: name, 
                    price: price, 
                    quantity: quantity 
                });
            }
            
            localStorage.setItem("cart", JSON.stringify(cart));
            updateCartCount();
            alert(`${quantity}x ${name} zum Warenkorb hinzugefügt!`);
        }

        function updateCartCount() {
            // Berechnet die Summe aller Stückzahlen im Warenkorb
            const totalItems = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
            const display = document.getElementById("cartCountDisplay");
            if (display) {
                display.innerText = `(${totalItems})`;
            }
        }

        function checkLogin() {
            const statusText = document.getElementById("userStatus");
            const authBtn = document.getElementById("auth-btn");
            const userEmail = localStorage.getItem("userEmail");

            if (userEmail) {
                const userName = userEmail.split('@')[0];
                statusText.innerHTML = `Hallo, <a href="Profile.html" style="text-decoration: underline;">${userName}</a>`;
                authBtn.innerText = "Logout";
                authBtn.onclick = function () {
                    localStorage.clear();
                    location.reload();
                };
            } else {
                statusText.innerText = "";
                authBtn.innerText = "Login / Register";
                authBtn.onclick = function () { window.location.href = "login.html"; };
            }
        }

        window.onload = function () {
            checkLogin();
            loadProducts();
            updateCartCount();
        };
    </script>
</body>

</html>
